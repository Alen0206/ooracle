<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>用户列表</title>
    <link rel="stylesheet" th:href="@{/static/layui/css/layui.css}">
    <script th:src="@{/static/layui/layui.js}"></script>
    <style>
        .layui-form-pane {
            margin-left: 20px;
            margin-right: 20px;
        }
    </style>
</head>
<body class="layui-layout-body">
<form class="layui-form layui-form-pane" action="" id="user" style="display: none;">

    <div class="layui-form-item" style="margin-top: 15px">
        <label class="layui-form-label">用户名</label>
        <div class="layui-input-block">
            <input type="text" name="username" class="layui-input" id="input_username">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-block">
            <input type="text" name="password" class="layui-input" id="input_password">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">手机号</label>
        <div class="layui-input-block">
            <input type="text" name="phone" class="layui-input" id="input_phone">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-block">
            <input type="text" name="address" class="layui-input" id="input_address">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">创建时间</label>
        <div class="layui-input-block">
            <input type="text" name="cretime" class="layui-input" id="input_cretime">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">权限</label>
        <div class="layui-input-block">
            <input type="text" name="role" class="layui-input" id="input_role">
        </div>
    </div>

</form>
<form class="layui-form layui-form-pane" action="" id="userEdit" style="display: none;" method=""
      onsubmit="return false;">
    <div class="layui-form-item" style="display: none">
        <label class="layui-form-label">ID</label>
        <div class="layui-input-block">
            <input type="text" name="id" class="layui-input" id="edit_id">
        </div>
    </div>
    <div class="layui-form-item" style="margin-top: 15px">
        <label class="layui-form-label">用户名</label>
        <div class="layui-input-block">
            <input type="text" name="username" class="layui-input" id="edit_username">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-block">
            <input type="text" name="password" class="layui-input" id="edit_password">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">手机号</label>
        <div class="layui-input-block">
            <input type="text" name="phone" class="layui-input" id="edit_phone">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-block">
            <input type="text" name="address" class="layui-input" id="edit_address">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" id="edit_btn" lay-submit lay-filter="formDemo">立即提交</button>
            <button class="layui-btn layui-btn-primary">取消</button>
        </div>
    </div>

</form>
<form class="layui-form layui-form-pane" action="" id="userInsert" style="display: none" method=""
      onsubmit="return false;">
    <div class="layui-form-item" style="margin-top: 15px">
        <label class="layui-form-label">用户名</label>
        <div class="layui-input-block">
            <input type="text" name="username" class="layui-input" id="insert_username">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-block">
            <input type="password" name="password" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">手机号</label>
        <div class="layui-input-block">
            <input type="text" name="phone" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-block">
            <input type="text" name="address" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">权限</label>
        <div class="layui-input-block">
            <input type="radio" name="role" value="ROLE_USER" title="用户" checked>
            <input type="radio" name="role" value="ROLE_ADMIN" title="管理员">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" id="insert_btn" lay-submit lay-filter="formDemo">立即提交</button>
            <button class="layui-btn layui-btn-primary">取消</button>
        </div>
    </div>

</form>
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo">后台管理系统</div>
        <!-- 头部区域（可配合layui已有的水平导航） -->
        <ul class="layui-nav layui-layout-left">
            <li class="layui-nav-item"><a href="">首页</a></li>
            <li class="layui-nav-item"><a href="">用户</a></li>
            <li class="layui-nav-item">
                <a href="javascript:;">其它系统</a>
                <dl class="layui-nav-child">
                    <dd><a href="">邮件管理</a></dd>
                    <dd><a href="">消息管理</a></dd>
                    <dd><a href="">授权管理</a></dd>
                </dl>
            </li>
        </ul>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <img src="https://ziyangimg.oss-cn-beijing.aliyuncs.com/default_head.jpeg" class="layui-nav-img">
                    <span th:text="${session.SPRING_SECURITY_CONTEXT.authentication.principal.username }"></span>
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="">基本资料</a></dd>
                    <dd><a href="">安全设置</a></dd>
                </dl>
            </li>
            <li class="layui-nav-item"><a th:href="@{/logout}">退出</a></li>
        </ul>
    </div>

    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul class="layui-nav layui-nav-tree" lay-filter="test">
                <li class="layui-nav-item  layui-nav-itemed">
                    <a class="" href="javascript:;">用户管理</a>
                    <dl class="layui-nav-child">
                        <dd><a href="/user"   class="layui-this">用户列表</a></dd>

                    </dl>
                </li>
                <li class="layui-nav-item">
                    <a href="javascript:;">商品管理</a>
                    <dl class="layui-nav-child">
                        <dd><a href="/goods">商品列表</a></dd>
                    </dl>
                </li>

                <li class="layui-nav-item">
                    <a href="javascript:;">订单管理</a>
                    <dl class="layui-nav-child">
                        <dd><a href="/admin/order">订单列表</a></dd>
                    </dl>
                </li>s
            </ul>
        </div>
    </div>

    <div class="layui-body">
        <!-- 内容主体区域 -->
        <div style="margin-left: 50px;margin-top: 50px;width: 1200px">
            <blockquote class="layui-elem-quote">
                <div class="layui-inline">
                    <div class="layui-input-inline">
                        <input type="text" value="" placeholder="请输入关键字" class="layui-input search_text">
                    </div>
                    <a class="layui-btn search_btn">查询</a>
                    <a class="layui-btn layui-btn-normal insert_btn">新增</a>
                </div>

            </blockquote>
        </div>
        <div style="margin-top: 10px;margin-left: 50px">
            <table id="test" class="layui-table " cellpadding="40dp" lay-data="{id: 'idTest'}"></table>
            <script type="text/html" id="barDemo">
                <a class="layui-btn layui-btn-normal  layui-btn-sm detail">查看</a>
                <a class="layui-btn  layui-btn-sm edit">编辑</a>
                <a class="layui-btn layui-btn-danger  layui-btn-sm del">删除</a>
            </script>
        </div>

    </div>

    <div class="layui-footer">
        <!-- 底部固定区域 -->
        © 5108工作室
    </div>

</div>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script>

    var checkUserName = true;

    layui.use(['table', 'element', 'jquery', 'layer', 'form'], function () {
        var table = layui.table,
            element = layui.element,
            $ = layui.jquery,
            form = layui.form,
            layer = layui.layer;
        //新增用户
        $('.insert_btn').click(function () {
            layer.open({
                type: 1,
                title: '新增用户',
                closeBtn: 0,
                area: '500px',
                shadeClose: true,
                skin: 'demo-class',
                content: $('#userInsert')
            });
        })


        $('#insert_btn').click(function () {
            if (checkUserName) {
                $.ajax({
                    url: '/api/user',
                    type: 'post',
                    data: $('#userInsert').serialize(),
                    success: function (data) {
                        layer.msg('修改成功', {icon: 1});
                        setTimeout(" layer.closeAll() ", 1500)
                        setTimeout("  $('.layui-laypage-btn').click()", 2000)
                    }
                })
            } else {
                layer.msg('用户名不可用', {icon: 5})
            }

        })

        //判断用户是否存在
        $('#insert_username').change(function () {
            var username = $(this).val();
            $.post("/api/user/check", {username: username},
                function (data) {
                    if (data.code == 0) {
                        checkUserName = false
                        layer.msg('用户名已存在', {icon: 5})
                    } else {
                        checkUserName = true;
                        layer.msg('用户名可用', {icon: 1})
                    }
                });
        })

        //查看用户详情
        function userDetail(id) {
            $.get('/api/user/' + id, function (data) {
                $('#input_cretime').val(data.data.cretime)
                $('#input_username').val(data.data.username)
                $('#input_password').val(data.data.password)
                $('#input_address').val(data.data.address)
                $('#input_phone').val(data.data.phone)
                if (data.data.role == 'ROLE_USER') {
                    $('#input_role').val('普通用户');
                } else {
                    $('#input_role').val('管理员');
                }
            })
            layer.open({
                type: 1,
                title: '用户详情',
                closeBtn: 0,
                area: '500px',
                shadeClose: true,
                skin: 'demo-class',
                content: $('#user')
            });
        }

        function userEdit(id) {
            $.get('/api/user/' + id, function (data) {
                $('#edit_id').val(id)
                $('#edit_username').val(data.data.username)
                $('#edit_password').val(data.data.password)
                $('#edit_address').val(data.data.address)
                $('#edit_phone').val(data.data.phone)
            })
            layer.open({
                type: 1,
                title: '修改用户信息',
                closeBtn: 0,
                area: '500px',
                shadeClose: true,
                skin: 'demo-class',
                content: $('#userEdit')
            });
        }

        //修改用户信息
        $('#edit_btn').click(function () {
            $.ajax({
                type: "put",
                url: "/api/user",
                data: $('#userEdit').serialize(),
                async: false,
                success: function (data) {
                    layer.msg('修改成功', {icon: 1});
                    setTimeout(" layer.closeAll() ", 1500)
                    setTimeout("  $('.layui-laypage-btn').click()", 2000)
                }
            })
        })

        table.render({
            elem: '#test'
            , url: '/api/users'
            , width: 1200
            //, cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , page: true
            , cols: [
                [
                    {field: 'id', title: 'ID', width: 100, sort: true}
                    , {field: 'username', width: 180, title: '用户名'}
                    , {field: 'phone', width: 180, title: '手机号', sort: true}
                    , {field: 'address', width: 180, title: '地址'}
                    , {field: 'cretime', width: 180, title: '创建时间'}
                    , {field: 'right', title: '操作', toolbar: "#barDemo"}
                ]
            ]
            , done: function () {
                /*
                删除用户
                 */
                $(".del").click(function () {
                    var id = $(this).parents('tr').children('td').eq(0).text();
                    var username = $(this).parents('tr').children('td').eq(1).text();
                    layer.confirm("确认删除" + username + "吗？", {
                        btn: ['是', '否'], btn1: function () {
                            {
                                $.ajax({
                                    url: '/api/user/' + id,
                                    type: "DELETE",
                                    success: function (data) {
                                        layer.msg(data.msg);
                                        if (data.code == 1) {
                                            //刷新表格
                                            $(".layui-laypage-btn").click()
                                        } else {
                                            alert("删除失败");
                                        }
                                    }
                                })
                            }
                        }, btn2: function () {
                            layer.msg("取消成功");
                        }
                    })
                })

                /*
                查看用户
                 */
                $(".detail").click(function () {
                    var id = $(this).parents('tr').children('td').eq(0).text();
                    userDetail(id)
                })
                /*
                编辑用户
                 */
                $(".edit").click(function () {
                    var id = $(this).parents('tr').children('td').eq(0).text();
                    userEdit(id)
                })
            }

        });

        $(".search_text").on('input', function () {
            var name = $('.search_text').val();
            if (name != "") {
                table.reload('idTest', {
                    url: '/api/user/search'
                    , width: 1200
                    , cols: [
                        [
                            {field: 'id', title: 'ID', width: 100, sort: true}
                            , {field: 'username', width: 180, title: '用户名'}
                            , {field: 'phone', width: 180, title: '手机号', sort: true}
                            , {field: 'address', width: 180, title: '地址'}
                            , {field: 'cretime', width: 180, title: '创建时间'}
                            , {field: 'right', title: '操作', toolbar: "#barDemo"}
                        ]
                    ]
                    , where: {
                        username: name
                    }
                    , loading: true
                    , done: function () {
                        /*
                        删除用户
                         */
                        $(".del").click(function () {
                            var id = $(this).parents('tr').children('td').eq(0).text();
                            var username = $(this).parents('tr').children('td').eq(1).text();
                            layer.confirm("确认删除" + username + "吗？", {
                                btn: ['是', '否'], btn1: function () {
                                    {
                                        $.ajax({
                                            url: "/api/user/" + id,
                                            type: "DELETE",
                                            success: function (data) {
                                                layer.msg(data.msg);
                                                if (data.data.code == 1) {
                                                    //刷新表格
                                                    $(".layui-laypage-btn").click()
                                                } else {
                                                    alert("删除失败");
                                                }
                                            }
                                        })
                                    }
                                }, btn2: function () {
                                    layer.msg("取消成功");
                                }
                            })
                        })

                        /*
                        查看用户
                         */
                        $(".detail").click(function () {
                            var id = $(this).parents('tr').children('td').eq(0).text();
                            userDetail(id);
                        })
                        /*
                        编辑用户
                         */
                        $(".edit").click(function () {
                            var id = $(this).parents('tr').children('td').eq(0).text();
                            userEdit(id)
                        })
                    }
                });
            } else {
                table.render({
                    elem: '#test'
                    , url: '/api/users'
                    , width: 1200
                    //, cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                    , page: true
                    , cols: [
                        [
                            {field: 'id', title: 'ID', width: 100, sort: true}
                            , {field: 'username', width: 180, title: '用户名'}
                            , {field: 'phone', width: 180, title: '手机号', sort: true}
                            , {field: 'address', width: 180, title: '地址'}
                            , {field: 'cretime', width: 180, title: '创建时间'}
                            , {field: 'right', title: '操作', toolbar: "#barDemo"}
                        ]
                    ]
                    , done: function () {
                        /*
                        删除用户
                         */
                        $(".del").click(function () {
                            var id = $(this).parents('tr').children('td').eq(0).text();
                            var username = $(this).parents('tr').children('td').eq(1).text();
                            layer.confirm("确认删除" + username + "吗？", {
                                btn: ['是', '否'], btn1: function () {
                                    {
                                        $.ajax({
                                            url: '/api/user/' + id,
                                            type: "DELETE",
                                            success: function (data) {
                                                layer.msg(data.msg);
                                                if (data.code == 1) {
                                                    //刷新表格
                                                    $(".layui-laypage-btn").click()
                                                } else {
                                                    alert("删除失败");
                                                }
                                            }
                                        })
                                    }
                                }, btn2: function () {
                                    layer.msg("取消成功");
                                }
                            })
                        })

                        /*
                        查看用户
                         */
                        $(".detail").click(function () {
                            var id = $(this).parents('tr').children('td').eq(0).text();
                            userDetail(id)
                        })
                        /*
                        编辑用户
                         */
                        $(".edit").click(function () {
                            var id = $(this).parents('tr').children('td').eq(0).text();
                            userEdit(id)
                        })
                    }

                });

            }
        })
    });

</script>

</body>
</html>